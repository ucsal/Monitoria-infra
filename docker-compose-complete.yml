version: '3.8'

# Sistema Completo de Monitorias UCSAL - 9 Microservi√ßos

services:
  # ==================== SERVICE DISCOVERY ====================
  eureka-server:
    build: ./eureka-server
    container_name: eureka-server
    ports: ["8761:8761"]
    networks: [monitoria-network]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==================== API GATEWAY ====================
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports: ["8080:8080"]
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      JWT_SECRET: 404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970
    depends_on:
      eureka-server: {condition: service_healthy}
    networks: [monitoria-network]

  # ==================== AUTH SERVICE ====================
  auth-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: auth_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5433:5432"]
    volumes: [auth-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  auth-service:
    build: ./auth-service
    ports: ["8081:8081"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://auth-db:5432/auth_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [auth-db, eureka-server]
    networks: [monitoria-network]

  # ==================== ACADEMIC SERVICE ====================
  academic-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: academic_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5434:5432"]
    volumes: [academic-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  academic-service:
    build: ./academic-service
    ports: ["8082:8082"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://academic-db:5432/academic_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [academic-db, eureka-server]
    networks: [monitoria-network]

  # ==================== STUDENT SERVICE ====================
  student-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: student_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5435:5432"]
    volumes: [student-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  student-service:
    build: ./student-service
    ports: ["8083:8083"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://student-db:5432/student_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [student-db, eureka-server]
    networks: [monitoria-network]

  # ==================== MONITORING SERVICE ====================
  monitoring-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: monitoring_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5436:5432"]
    volumes: [monitoring-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  monitoring-service:
    build: ./monitoring-service
    ports: ["8084:8084"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://monitoring-db:5432/monitoring_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [monitoring-db, eureka-server]
    networks: [monitoria-network]

  # ==================== ATTENDANCE SERVICE ====================
  attendance-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: attendance_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5437:5432"]
    volumes: [attendance-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  attendance-service:
    build: ./attendance-service
    ports: ["8085:8085"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://attendance-db:5432/attendance_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [attendance-db, eureka-server]
    networks: [monitoria-network]

  # ==================== CONTENT SERVICE ====================
  content-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: content_service_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports: ["5438:5432"]
    volumes: [content-db-data:/var/lib/postgresql/data]
    networks: [monitoria-network]

  content-service:
    build: ./content-service
    ports: ["8086:8086"]
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://content-db:5432/content_service_db
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on: [content-db, eureka-server]
    networks: [monitoria-network]

volumes:
  auth-db-data:
  academic-db-data:
  student-db-data:
  monitoring-db-data:
  attendance-db-data:
  content-db-data:

networks:
  monitoria-network:
    driver: bridge
